<template>
  <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
    <div class="p-4">
      <h3 class="text-base md:text-lg font-semibold text-gray-900 dark:text-white mb-1">
        {{ t('matchups.vulnerability') }}
      </h3>
      <p class="text-xs md:text-sm text-gray-500 dark:text-gray-400 mb-4">
        {{ t('matchups.vulnerabilityDesc') }}
      </p>

      <!-- Mobile: Dropdown select -->
      <div class="md:hidden mb-4 relative">
        <select
          v-model="selectedTeamId"
          class="w-full px-3 py-2.5 pr-10 text-sm rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500/40 focus:border-cyan-500 transition-colors appearance-none"
          @change="onDropdownChange"
        >
          <option value="">{{ t('matchups.selectTeam') }}</option>
          <option v-for="team in teams" :key="team.team_id" :value="team.team_id">
            {{ team.team_name }}
          </option>
        </select>
        <ChevronDown class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" />
      </div>

      <!-- Desktop: Search bar with autocomplete -->
      <div class="hidden md:block relative mb-4">
        <Search class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 z-10" />
        <input
          ref="searchInputRef"
          v-model="searchQuery"
          type="search"
          autocomplete="off"
          autocorrect="off"
          autocapitalize="off"
          spellcheck="false"
          :placeholder="t('matchups.selectTeam')"
          class="w-full pl-10 pr-4 py-2.5 text-base rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500/40 focus:border-cyan-500 transition-colors"
          @focus="showSuggestions = true"
          @blur="onBlur"
          @input="onInputNative"
          @keyup="onInputNative"
          @keydown.escape="showSuggestions = false"
          @keydown.down.prevent="navigateSuggestion(1)"
          @keydown.up.prevent="navigateSuggestion(-1)"
          @keydown.enter.prevent="selectHighlighted"
        />

        <!-- Suggestions dropdown -->
        <div
          v-if="showSuggestions && filteredTeams.length > 0"
          class="absolute left-0 right-0 top-full mt-1 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl shadow-lg z-50 max-h-60 overflow-y-auto"
        >
          <button
            v-for="(team, idx) in filteredTeams"
            :key="team.team_id"
            class="w-full flex items-center gap-2.5 px-3 py-2 text-left hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors"
            :class="{ 'bg-cyan-50 dark:bg-cyan-900/20': highlightedIndex === idx }"
            @mousedown.prevent="selectTeam(team)"
          >
            <img :src="team.team_logo" :alt="team.team_name" class="w-5 h-5 object-contain" />
            <span class="text-sm text-gray-900 dark:text-white">{{ team.team_name }}</span>
            <span class="text-xs text-gray-400">({{ team.team_short }})</span>
          </button>
        </div>
      </div>

      <!-- Selected team chip (desktop only) -->
      <div v-if="selectedTeam" class="hidden md:flex items-center gap-2 mb-4">
        <span class="inline-flex items-center gap-2 pl-2 pr-1 py-1.5 text-sm font-medium rounded-full bg-cyan-100 dark:bg-cyan-900/40 text-cyan-700 dark:text-cyan-300">
          <img :src="selectedTeam.team_logo" :alt="selectedTeam.team_name" class="w-4 h-4 object-contain" />
          {{ selectedTeam.team_name }}
          <button
            class="ml-0.5 p-0.5 rounded-full hover:bg-cyan-200 dark:hover:bg-cyan-800 transition-colors"
            @click="clearSelection"
          >
            <X class="w-3.5 h-3.5" />
          </button>
        </span>
      </div>

      <!-- Chart container -->
      <div v-if="selectedTeam" class="relative w-full max-w-lg mx-auto">
        <canvas ref="canvasRef" />
      </div>

      <!-- Empty state -->
      <div v-else class="py-8 text-center">
        <Shield class="w-12 h-12 mx-auto text-gray-300 dark:text-gray-600 mb-3" />
        <p class="text-sm text-gray-500 dark:text-gray-400">
          {{ t('matchups.selectTeam') }}
        </p>
      </div>

      <!-- Vulnerability summary -->
      <div v-if="selectedTeam" class="mt-4 flex flex-col sm:flex-row gap-3">
        <div class="flex-1 p-3 rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800">
          <p class="text-xs text-red-600 dark:text-red-400 font-medium mb-1">{{ t('matchups.mostVulnerable') }}</p>
          <p class="text-sm md:text-base font-semibold text-red-700 dark:text-red-300">
            {{ getPositionLabel(mostVulnerablePosition) }}
            <span class="text-xs font-normal">({{ mostVulnerablePoints.toFixed(1) }} pts)</span>
          </p>
        </div>
        <div class="flex-1 p-3 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800">
          <p class="text-xs text-emerald-600 dark:text-emerald-400 font-medium mb-1">{{ t('matchups.leastVulnerable') }}</p>
          <p class="text-sm md:text-base font-semibold text-emerald-700 dark:text-emerald-300">
            {{ getPositionLabel(leastVulnerablePosition) }}
            <span class="text-xs font-normal">({{ leastVulnerablePoints.toFixed(1) }} pts)</span>
          </p>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch, onMounted, onUnmounted, nextTick } from 'vue'
import { useI18n } from 'vue-i18n'
import { Search, X, Shield, ChevronDown } from 'lucide-vue-next'
import {
  Chart as ChartJS,
  BarController,
  CategoryScale,
  LinearScale,
  BarElement,
  Tooltip,
} from 'chart.js'
import type { TeamMatchupData } from '@/mocks/marketMock'

ChartJS.register(BarController, CategoryScale, LinearScale, BarElement, Tooltip)

const props = defineProps<{
  teams: TeamMatchupData[]
}>()

const { t } = useI18n()

const searchQuery = ref('')
const showSuggestions = ref(false)
const highlightedIndex = ref(-1)
const selectedTeam = ref<TeamMatchupData | null>(null)
const selectedTeamId = ref('')
const searchInputRef = ref<HTMLInputElement | null>(null)
const canvasRef = ref<HTMLCanvasElement | null>(null)
let chartInstance: ChartJS | null = null

const filteredTeams = computed(() => {
  if (!searchQuery.value.trim()) return props.teams
  const q = searchQuery.value.toLowerCase()
  return props.teams.filter(t =>
    t.team_name.toLowerCase().includes(q) ||
    t.team_short.toLowerCase().includes(q)
  )
})

const mostVulnerablePosition = computed(() => {
  if (!selectedTeam.value) return 'mid'
  const t = selectedTeam.value
  const max = Math.max(t.points_conceded_def, t.points_conceded_mid, t.points_conceded_fwd)
  if (max === t.points_conceded_fwd) return 'fwd'
  if (max === t.points_conceded_mid) return 'mid'
  return 'def'
})

const leastVulnerablePosition = computed(() => {
  if (!selectedTeam.value) return 'def'
  const t = selectedTeam.value
  const min = Math.min(t.points_conceded_def, t.points_conceded_mid, t.points_conceded_fwd)
  if (min === t.points_conceded_def) return 'def'
  if (min === t.points_conceded_mid) return 'mid'
  return 'fwd'
})

const mostVulnerablePoints = computed(() => {
  if (!selectedTeam.value) return 0
  const t = selectedTeam.value
  return Math.max(t.points_conceded_def, t.points_conceded_mid, t.points_conceded_fwd)
})

const leastVulnerablePoints = computed(() => {
  if (!selectedTeam.value) return 0
  const t = selectedTeam.value
  return Math.min(t.points_conceded_def, t.points_conceded_mid, t.points_conceded_fwd)
})

function getPositionLabel(pos: string): string {
  switch (pos) {
    case 'def': return t('matchups.defender')
    case 'mid': return t('matchups.midfielder')
    case 'fwd': return t('matchups.forward')
    default: return pos
  }
}

function onBlur() {
  setTimeout(() => {
    showSuggestions.value = false
    highlightedIndex.value = -1
  }, 150)
}

function onInputNative() {
  showSuggestions.value = true
  highlightedIndex.value = -1
}

function navigateSuggestion(dir: number) {
  const max = filteredTeams.value.length - 1
  if (max < 0) return
  let next = highlightedIndex.value + dir
  if (next < 0) next = max
  if (next > max) next = 0
  highlightedIndex.value = next
}

function selectHighlighted() {
  if (highlightedIndex.value >= 0 && highlightedIndex.value < filteredTeams.value.length) {
    selectTeam(filteredTeams.value[highlightedIndex.value])
  }
}

function selectTeam(team: TeamMatchupData) {
  selectedTeam.value = team
  selectedTeamId.value = team.team_id
  searchQuery.value = ''
  showSuggestions.value = false
  highlightedIndex.value = -1
  nextTick(() => createChart())
}

function onDropdownChange() {
  if (!selectedTeamId.value) {
    clearSelection()
    return
  }
  const team = props.teams.find(t => t.team_id === selectedTeamId.value)
  if (team) {
    selectedTeam.value = team
    nextTick(() => createChart())
  }
}

function clearSelection() {
  selectedTeam.value = null
  selectedTeamId.value = ''
  if (chartInstance) {
    chartInstance.destroy()
    chartInstance = null
  }
}

function createChart() {
  if (!canvasRef.value || !selectedTeam.value) return

  const ctx = canvasRef.value.getContext('2d')
  if (!ctx) return

  if (chartInstance) {
    chartInstance.destroy()
  }

  const team = selectedTeam.value
  const isDark = document.documentElement.classList.contains('dark')

  const labels = [
    t('matchups.defender'),
    t('matchups.midfielder'),
    t('matchups.forward'),
  ]

  const data = [
    team.points_conceded_def,
    team.points_conceded_mid,
    team.points_conceded_fwd,
  ]

  const colors = [
    '#3b82f6', // blue for DEF
    '#22c55e', // green for MID
    '#f97316', // orange for FWD
  ]

  chartInstance = new ChartJS(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: colors,
        borderRadius: 6,
        barThickness: 40,
      }],
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: true,
      animation: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: true,
          backgroundColor: 'rgba(0, 0, 0, 0.85)',
          titleColor: '#fff',
          bodyColor: '#fff',
          padding: 10,
          cornerRadius: 8,
          callbacks: {
            label: (context) => {
              const val = context.parsed.x ?? 0
              return `${val.toFixed(1)} ${t('matchups.pointsConceded')}`
            },
          },
        },
      },
      scales: {
        x: {
          beginAtZero: true,
          grid: {
            color: isDark ? 'rgba(156, 163, 175, 0.15)' : 'rgba(156, 163, 175, 0.25)',
          },
          ticks: {
            color: isDark ? 'rgb(156, 163, 175)' : 'rgb(107, 114, 128)',
            font: { size: 11 },
          },
        },
        y: {
          grid: { display: false },
          ticks: {
            color: isDark ? 'rgb(229, 231, 235)' : 'rgb(31, 41, 55)',
            font: { size: 12, weight: 600 },
          },
        },
      },
    },
  })
}

watch(() => selectedTeam.value, () => {
  if (selectedTeam.value) {
    nextTick(() => createChart())
  }
})

onMounted(() => {
  if (selectedTeam.value) {
    nextTick(() => createChart())
  }
})

onUnmounted(() => {
  if (chartInstance) {
    chartInstance.destroy()
    chartInstance = null
  }
})
</script>
